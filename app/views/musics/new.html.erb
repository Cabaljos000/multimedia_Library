<% content_for :title, "New music" %>

<h1 class="font-bold text-4xl mbe-4">New music</h1>

<div id="spotify-search-container" class="mb-4 hidden">
  <input type="text" id="spotify-query" placeholder="Enter song name" class="border px-2 py-1 rounded w-1/2">
  <button id="spotify-search-btn" class="btn ml-2">Search</button>
</div>

<%= render "form", model: @music %>

<div class="inline-flex flex-wrap items-center gap mbs-2" style="--row-gap: .5rem">
  <%= link_to "Back to music", musics_path, class: "btn" %>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const radios = document.querySelectorAll('input[name="entry_mode"]');
    const searchContainer = document.getElementById("spotify-search-container");
    const searchBtn = document.getElementById("spotify-search-btn");

    radios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "spotify" && radio.checked) {
          searchContainer.classList.remove("hidden");
        } else {
          searchContainer.classList.add("hidden");
        }
      });
    });

    searchBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const query = document.getElementById("spotify-query").value;

      if (!query.trim()) return;

      fetch(`/musics/search?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert("No results found.");
            return;
          }

          // Fill in the form fields
          document.getElementById("music_title").value = data.title || "";
          document.getElementById("music_artist").value = data.artist || "";
          document.getElementById("music_album").value = data.album || "";
          document.getElementById("music_genre").value = data.genre || "";
          document.getElementById("music_year").value = data.year;
          document.getElementById("music_image_url").value = data.image_url || "";
          const imageContainer = document.getElementById("spotify-image-container");
          const imageUrl = data.image_url;
          imageContainer.innerHTML = `<img src="${imageUrl}" alt="Album artwork" style="width: 150px; height: 150px;">`;
        })
        .catch(err => {
          console.error(err);
          alert("Something went wrong searching Spotify.");
        });
    });
  });
</script>
